<!DOCTYPE html>
<html lang="en">
  <!-- Previous head section remains the same -->
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Application</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
    />
    <style>
      /* Previous styles remain the same */
      body {
        display: flex;
        flex-direction: column;
        height: 100vh;
        margin: 0;
        font-family: Arial, sans-serif;
      }
      #left-menu {
        width: 250px;
        border-right: 1px solid #ddd;
        padding-top: 20px;
        background-color: #f4f4f4;
      }
      #chat-window {
        flex: 1;
        padding: 20px;
        background-color: #fff;
        overflow-y: auto;
      }
      .content {
        display: flex;
        flex: 1;
      }
      #chat-content {
        max-height: 70%;
        overflow-y: auto;
        margin-bottom: 20px;
        border: 1px solid #ddd;
        padding: 10px;
        background-color: #f9f9f9;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
      }
      .message-container {
        display: flex;
        flex-direction: column;
        width: 100%;
        padding: 10px;
        box-sizing: border-box;
      }
      .message {
        padding: 10px 15px;
        border-radius: 10px;
        background-color: #f4f4f4;
        color: black;
        text-align: left;
      }
      .message-author {
        font-size: 0.75rem;
        margin-top: 4px;
        opacity: 0.7;
        text-align: right;
      }
      .sender-container {
        justify-content: flex-end;
      }
      .receiver-container {
        justify-content: flex-start;
      }
      .sender {
        background-color: #0084ff;
        color: white;
        border-bottom-right-radius: 5px;
      }
      .receiver {
        background-color: #e9ecef;
        color: black;
        border-bottom-left-radius: 5px;
      }
      .chat-footer {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      #chat-input {
        resize: none;
        height: 70px;
      }
      .btn-send {
        background-color: #0084ff;
        color: white;
        border: none;
        padding: 10px;
        font-size: 16px;
        cursor: pointer;
        border-radius: 5px;
      }
      .btn-send:hover {
        background-color: #0073e6;
      }
      .message-time {
        font-size: 0.75rem;
        margin-top: 4px;
        opacity: 0.7;
      }
      .sender .message-time {
        text-align: right;
      }
    </style>
  </head>
  <body>
    <!-- Navbar section remains the same -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">ChatApp</a>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            {% if user.is_authenticated %}
            <li class="nav-item">
              <span class="nav-link">Hi, {{ user.username }}</span>
            </li>
            <li class="nav-item">
              <form method="post" action="{% url 'logout' %}">
                {% csrf_token %}
                <button class="btn btn-link text-light" type="submit">
                  Logout
                </button>
              </form>
            </li>
            {% else %}
            <li class="nav-item">
              <a class="nav-link" href="{% url 'login' %}">Login</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'register' %}">Register</a>
            </li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content section remains the same -->
    <div class="content">
      <div id="left-menu">
        <button
          class="btn btn-primary w-100 mt-2"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#user-list"
          aria-expanded="false"
          aria-controls="user-list"
        >
          Users
        </button>
        <div class="collapse mt-2" id="user-list">
          <ul class="list-group">
            {% for user in users %}
            <li class="list-group-item">
              <a
                href="#"
                onclick="openChat('{{ request.user.id }}', '{{ user.id }}', '{{ user.username }}')"
              >
                {{ user.username }}
              </a>
            </li>
            {% empty %}
            <li class="list-group-item">No other users available</li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <div id="chat-window">
        <h3 id="chat-header">Welcome, {{ request.user.username }}</h3>
        <div id="chat-content">
          <p>Select a user to start chatting.</p>
        </div>
        <div class="chat-footer">
          <textarea
            id="chat-input"
            class="form-control"
            placeholder="Type a message..."
          ></textarea>
          <button class="btn-send mt-2 w-100" onclick="sendMessage()">
            Send
          </button>
        </div>
      </div>
    </div>

    <script>
      let chatSocket = null;
      let activeUserId = null;
      let currentUserId = null;

      function createMessageElement(
        message,
        senderId,
        currentUserId,
        timestamp = new Date().toLocaleTimeString()
      ) {
        const messageContainer = document.createElement("div");
        messageContainer.className = "message-container";

        const messageElement = document.createElement("div");
        messageElement.className = "message";
        messageElement.textContent = message;

        const authorElement = document.createElement("div");
        authorElement.className = "message-author";
        authorElement.textContent =
          senderId.toString() === currentUserId.toString()
            ? `You • ${timestamp}`
            : `User ${senderId} • ${timestamp}`;

        messageContainer.appendChild(messageElement);
        messageContainer.appendChild(authorElement);

        return messageContainer;
      }

      function openChat(sender, receiver, username) {
        currentUserId = sender;
        activeUserId = receiver;
        document.getElementById(
          "chat-header"
        ).innerText = `Chat with ${username}`;
        document.getElementById("chat-content").innerHTML = "";

        fetch(`/get_chat/${receiver}/`)
          .then((response) => response.json())
          .then((data) => {
            const messages = data.messages;
            messages.forEach((msg) => {
              const messageElement = createMessageElement(
                msg.message,
                msg.sender,
                currentUserId,
                msg.timestamp
              );
              document
                .getElementById("chat-content")
                .appendChild(messageElement);
            });
            scrollToBottom();
          })
          .catch((error) =>
            console.error("Error fetching chat history:", error)
          );

        if (chatSocket) {
          chatSocket.close();
        }

        chatSocket = new WebSocket(
          `ws://${window.location.host}/ws/chat/${sender}${receiver}/`
        );

        chatSocket.onmessage = function (e) {
          const data = JSON.parse(e.data);
          if (data.sender.toString() !== currentUserId.toString()) {
            const messageElement = createMessageElement(
              data.message,
              data.sender,
              currentUserId,
              new Date().toLocaleTimeString()
            );
            document.getElementById("chat-content").appendChild(messageElement);
            scrollToBottom();
          }
        };

        chatSocket.onclose = function (e) {
          console.error("Chat socket closed unexpectedly");
        };
      }

      function sendMessage() {
        const messageInput = document.getElementById("chat-input");
        const message = messageInput.value.trim();

        if (message && chatSocket) {
          chatSocket.send(
            JSON.stringify({
              message: message,
            })
          );

          const messageElement = createMessageElement(
            message,
            currentUserId,
            currentUserId,
            new Date().toLocaleTimeString()
          );
          document.getElementById("chat-content").appendChild(messageElement);
          scrollToBottom();

          messageInput.value = "";
        }
      }

      function scrollToBottom() {
        const chatContent = document.getElementById("chat-content");
        chatContent.scrollTop = chatContent.scrollHeight;
      }

      document
        .getElementById("chat-input")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
